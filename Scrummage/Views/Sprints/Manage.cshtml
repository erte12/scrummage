@using Scrummage.Models
@using Scrummage.ViewModels
@model SprintManageViewModel

@{
    ViewBag.Title = "Manage Sprint";
}

<h2>Manage Sprint - @Model.Name (@Model.StartsAt.ToString("d") - @Model.EndsAt.ToString("d")) - Team: @Model.Team.Name</h2>
<hr/>
<div class="row">
    <div class="col-lg-2">
        @Html.ActionLink("Scrum board", "Index", 
            new { Model.Id }, 
            new { @class = "btn btn-primary btn-block" })
    </div>
    <div class="col-lg-2">
        @Html.ActionLink("Statistics", "Statistics", "Sprints", 
            new { id = @Model.Id }, 
            new { @class = "btn btn-primary btn-block" })
    </div>
    <div class="col-lg-2">
        @Html.ActionLink("New sprint", "New", "Sprints",
            new {teamId = @Model.Team.Id},
            new {@class = "btn btn-success btn-block" })
    </div>
    <div class="col-lg-2">
        @Html.ActionLink("Events", "Index", "Events",
            new {teamId = @Model.Team.Id},
            new {@class = "btn btn-warning btn-block" })
    </div>
    <div class="col-lg-offset-2 col-lg-2">
        @using(Html.BeginForm("Delete", "Sprints", FormMethod.Post)) {
            <button id="deleteButton" type="button" class="btn btn-danger btn-block">Delete this sprint</button>
            @Html.HiddenFor(m => m.Id)
        }
    </div>
</div>
<hr/>

<div class="row">
    <div class="col-md-6">
        <h3>Add new task to backlog</h3>
        <form id="newTask">
            <div class="form-group">
                <label class="control-label">Title</label>
                <input type="text" id="title" name="title" class="form-control" />
            </div>
            <div class="form-group">
                <label for="content" class="control-label">Content</label>
                <textarea name="content" id="content" rows="6" class="form-control"></textarea>
            </div>
            <input name="sprintId" type="hidden" value="@Model.Id"/>
            <button class="btn btn-primary">Submit</button>
        </form>
    </div>
    <div class="col-md-6">
        <h3>Sprint Information</h3>
        <form id="sprintForm">
            <div class="form-group">
                <label for="name" class="control-label">Name</label>
                <input type="text" id="name" name="name" value="@Model.Name" class="form-control"/>
            </div>
            <div class="form-group">
                <label for="description" class="control-label">Description</label>
                <textarea id="description" name="description" rows="6" class="form-control">@Model.Description</textarea>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
</div>

<hr/>
<h2>Backlog</h2>
<table id="tasks" class="table table-bordered table-hover vertical-align">
    <thead>
        <tr>
            <th>Title</th>
            <th>Task content</th>
            <th>Who</th>
            <th>Estimation</th>
            <th>Priority</th>
            <th>Delete</th>
            <th hidden>Created at</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

@section scripts
{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/handlebars")

    @* Task Row template *@
    <script id="taskRow" type="text/x-handlebars-template">
        @Html.Partial("_TaskRow", new SprintManageTaskRowViewModel
        {
            Users = Model.Users,
            Estimations = Model.Estimations
        })
    </script>
    
    @* Render table content *@
    <script>
        var source = $('#taskRow').html();
        var template = Handlebars.compile(source);
        var table = $('#tasks');

        $.get('/Api/ScrumTasks?sprintId=' + @Model.Id, function (data) {
            data.forEach(function (task) {
                var taskRowHtml = template(task);
                $('#tasks tbody').append(taskRowHtml);
            });
        }).done(function() {
            table = table.DataTable({
                "order": [5, 'desc']
            });
        });

        $('#sprintForm').validate({
            rules: {
                name: {
                    required: true,
                    minlength: 3,
                    maxlength: 60
                },
                description: {
                    maxlength: 1000
                }
            },
            submitHandler: function () {
                $.ajax({
                    url: '/Api/Sprints/@Model.Id',
                    method: 'patch',
                    data: $('#sprintForm').serialize()
                })
                .done(function() {
                    toastr.success('Changes has been saved');
                })
                .fail(function (data) {
                    console.log(data.responseJSON.modelState);

                    toastr.error('Something went wrong');
                });

                return false;
            }
        });

        $("#sprintForm").enter();

        $('#newTask').validate({
            rules: {
                title: {
                    required: true,
                    minlength: 3,
                    maxlength: 40
                },
                content: {
                    required: true,
                    minlength: 3,
                    maxlength: 400
                }
            },
            submitHandler: function () {

                $.ajax({
                    url: '/Api/ScrumTasks/',
                    method: 'post',
                    data: $('#newTask').serialize()
                })
                .done(function(data) {
                    toastr.success('New task has been created');
                    var taskRowHtml = template(data);
                    $('#newTask').find("input[type=text], textarea").val("");
                    $('#newTask').find("input[type=text]").focus();
                    table.row.add($(taskRowHtml)).draw();
                })
                .fail(function (data) {
                    console.log(data);
                    toastr.error('Something went wrong');
                });

                return false;
            }
        });

        $("#newTask").enter();

        $('#tasks tbody').on('change', '.js-members', function () {
            var userId = $(this).val();
            var scrumTaskId = $(this).parents('tr').attr('data-task-id');

            $.ajax({
                url: '/api/scrumtasks/' + scrumTaskId,
                method: 'patch',
                data: { userId: userId }
            })
            .done(function() {
                toastr.success('User set successfully');
            })
            .fail(function() {
                toastr.error('Something went wrong');
            });
        });

        $('#tasks tbody').on('change', '.js-estimations', function() {
            var estimationId = $(this).val();
            var scrumTaskId = $(this).parents('tr').attr('data-task-id');

            $.ajax({
                    url: '/api/scrumtasks/' + scrumTaskId,
                    method: 'patch',
                    data: { estimationId: estimationId }
                })
                .done(function() {
                    toastr.success('Estimation set successfully');
                })
                .fail(function() {
                    toastr.error('Something went wrong');
                });
            });

        $('#tasks tbody').on('change', '.js-priority', function() {
            var priority = $(this).val();
            var scrumTaskId = $(this).parents('tr').attr('data-task-id');

            $.ajax({
                url: '/api/scrumtasks/' + scrumTaskId,
                method: 'patch',
                data: { priority: priority }
            })
            .done(function() {
                toastr.success('Priority changed successfully');
            })
            .fail(function() {
                toastr.error('Something went wrong');
            });
        });

        $('#tasks tbody').on('click', '.js-delete', function () {

            var taskRow = $(this).parents('tr');

            var taskId = taskRow.attr('data-task-id');

            bootbox.confirm({
                title: "Delete task?",
                message: "Do you want to delete this task? This cannot be undone.",
                buttons: {
                    cancel: {
                        label: '<i class="fa fa-times"></i> Cancel'
                    },
                    confirm: {
                        label: '<i class="fa fa-check"></i> Confirm'
                    }
                },
                callback: function (result) {
                    if (result === true) {
                        $.ajax({
                            url: '/api/scrumtasks/' + taskId,
                            method: 'delete'
                        })
                        .done(function() {
                            toastr.success('Task successfully deleted');
                            table.rows(taskRow).remove().draw();
                        })
                        .fail(function() {
                            toastr.error('Something went wrong');
                        });
                    }
                }
            });
        });

        $('#tasks tbody').on('click', '.js-editable', function () {
            var contentElement = $(this);
            var content = contentElement.text();
            var scrumTaskId = contentElement.parents('tr').attr('data-task-id');

            bootbox.prompt({
                title: "Edit task's content",
                inputType: 'textarea',
                value: content,
                callback: function (newContent) {
                    if (newContent != null) {
                        $.ajax({
                            url: '/api/scrumtasks/' + scrumTaskId,
                            method: 'patch',
                            data: { content: newContent }
                        })
                        .done(function() {
                            toastr.success('Content updated successfully');
                            contentElement.html(newContent);
                        })
                        .fail(function() {
                            toastr.error('Something went wrong');
                        });

                    }
                }
            });
        });

        $('#deleteButton').on('click', function (event) {
            event.preventDefault();
            bootbox.confirm({
                title: "Delete sprint?",
                message: "Do you want to delete this sprint? This cannot be undone.",
                buttons: {
                    cancel: {
                        label: '<i class="fa fa-times"></i> Cancel'
                    },
                    confirm: {
                        label: '<i class="fa fa-check"></i> Confirm'
                    }
                },
                callback: function (result) {
                    if (result === true)
                        $('#deleteButton').parents('form').submit();
                }
            });
        });
    </script>
}
