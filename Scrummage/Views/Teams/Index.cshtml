@model dynamic

@{
    ViewBag.Title = "Manage Teams";
}

<h2>Manage Teams</h2>
<hr/>

<div class="row">
    <div class="col-md-2">
        <button id="newTeamButton" type="button" class="btn btn-success btn-block">New team</button>
    </div>
</div>
<hr/>

<div class="row">
    <div class="col-md-6">
        <h3>Your teams</h3>
        <table id="teamsTable" class="table table-bordered table-hover">
            <thead>
            <tr>
                <th>Team</th>
                <th>Number of members</th>
                <th>Delete</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

@section scripts
{
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/handlebars")

    @* Task Row template *@
    <script id="teamRow" type="text/x-handlebars-template">
        @Html.Partial("_TeamRow")
    </script>

    <script>
        var source = $('#teamRow').html();
        var template = Handlebars.compile(source);
        var table = $('#teamsTable');

        $.get('/Api/Teams', function (data) {
            data.forEach(function (team) {
                var teamRowHtml = template(team);
                $('#teamsTable tbody').append(teamRowHtml);
            });
        }).done(function() {
            table = table.DataTable();
        });

        $('#newTeamButton').on('click', function() {
            bootbox.prompt({ 
                size: "small",
                title: "Team name:", 
                callback: function(name) {
                    if (name != null) {
                        $.ajax({
                            url: '/Api/Teams',
                            method: 'post',
                            data: {name: name}
                        })
                        .done(function(newTeam) {
                            toastr.success('New team has been created!');
                            var teamRowHtml = template(newTeam);
                            table.row.add($(teamRowHtml)).draw();
                            //TODO: Validation
                        })
                        .fail(function() {
                            toastr.error('Something went wrong!');
                        });
                    }
                }
            });
        });

        $('#newTeam').validate({
            submitHandler: function() {
                $.ajax({
                    url: '/Api/Teams',
                    method: 'post',
                    data: $('#newTeam').serialize()
                })
                .done(function(newTeam) {
                    toastr.success('New team has been created!');
                    $('#newTeam').find('input').val('');

                    //TODO: Insert new team to table
                })
                .fail(function() {
                    toastr.error('Something went wrong!');
                });

                return false;
            }
        });

        $('#teamsTable tbody').on('click', '.js-delete', function () {

            var teamRow = $(this).parents('tr');
            var teamId = teamRow.attr('data-team-id');

            bootbox.confirm({
                title: "Delete team?",
                message: "Do you want to delete this team? This cannot be undone.",
                buttons: {
                    cancel: {
                        label: '<i class="fa fa-times"></i> Cancel'
                    },
                    confirm: {
                        label: '<i class="fa fa-check"></i> Confirm'
                    }
                },
                callback: function (result) {
                    if (result === true) {
                        $.ajax({
                                url: '/Api/Teams/' + teamId,
                                method: 'delete'
                            })
                            .done(function() {
                                toastr.success('Team successfully deleted');
                                table.rows(teamRow).remove().draw();
                            })
                            .fail(function() {
                                toastr.error('Something went wrong');
                            });
                    }
                }
            });
        });
    </script>
}
